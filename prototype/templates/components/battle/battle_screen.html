<div id="battle-screen">
    <div class="player-box">
        <div class="stats">
            <h2 class="banner">{{ player.title }}</h2>
            <div class="player-info">
                <div id="player-avatar">
                    <img id="player-avatar-img" src="{{ url_for('static', filename='assets/images/avatar_icons/players/con1.png') }}" alt="Player Avatar">
                </div>
                <div>
                    <p><strong>Name:</strong> {{ player.username }}</p>
                    <p><strong>Level:</strong> {{ player.level }}</p>
                    <p><strong>Experience:</strong> {{ player.exp }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div style="text-align: center;">
        <button class="battle-btn" data-dialog-target="startBattleModal" onclick="loadBattleModalQuests()">Initiate Battle</button>
    </div>
    
    <div id="subject-cards">
        {% for subject in subjects %}
        <div class="subject-card" data-subject-id="{{ subject.id }}" data-subject-code-name="{{ subject.code_name }}" onclick="selectOpponent('{{ subject.id }}')">
            <div class="subject-name">{{ subject.code_name }}</div>
            <div class="difficulty-stars">{{ "‚≠ê" * subject.difficulty }}</div>
            <div class="subject-stats">
                <div class="stat-row">
                    <span class="stat-label">Notes</span>
                    <span class="stat-value">{{ subject.notes|length }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Flashcards</span>
                    <span class="stat-value">{{ subject.flashcards|length }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Quests</span>
                    <span class="stat-value">{{ subject.quests|length }}</span>
                </div>
                {% if subject.last_battle %}
                <div class="stat-row">
                    <span class="stat-label">Last Battle</span>
                    <span class="stat-value">{{ subject.last_battle.strftime('%Y-%m-%d') }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        <div class="subject-card add-subject-card" data-dialog-target="addSubjectModal">
            <div class="add-icon">
                <i class="fas fa-scroll"></i>
            </div>
            <div class="subject-name">New Subject</div>
        </div>
    </div>
</div>


{% from "components/modal.html" import modal %}
{% call modal('addSubjectModal', 'Add new Subject') %}
    <form id="addSubjectForm" method="POST" action="{{ url_for('study_routes.create_subject') }}">
        <input type="text" name="user_id" value="{{ session['user_id'] }}" hidden>
        <div class="form-group">
            <label>Subject Code Name</label>
            <input type="text" name="code_name" required placeholder="SoftEng">
        </div>
        <div class="form-group">
            <label>Subject Description</label>
            <input type="text" name="description" required placeholder="Software Engineering">
        </div>
        <div class="form-group">
            <label>Difficulty</label>
            {% from "components/utils/star_rating.html" import star_rating %}
            {{ star_rating(name="subjectDifficulty", size="medium") }}
        </div>
        <div class="form-actions">
            <button type="button" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Create</button>
        </div>
    </form>
{% endcall %}

{% call modal('startBattleModal', 'Start Battle') %}
    <form id="startBattleForm" method="POST">
        <input type="text" name="user_id" value="{{ session['user_id'] }}" hidden>
        <input type="text" name="target_url" value="{{ url_for('study_routes.start_session') }}" hidden>
        <div class="form-group">            
            <label id="opponent-title">Subject</label>
            <div class="quest-list-container">
                <ul id="battle-quest-list" class="scrollable-list">
                    <!-- Quests will be dynamically populated by JavaScript -->
                </ul>
                <div class="empty-state" id="empty-quests-list">
                    <i class="fas fa-scroll"></i>
                    <p>No active quests</p>
                </div>
            </div>
        </div>
        <div class="form-group duration-input">
            <label for="battle_duration">Battle Duration (minutes):</label>
            <input type="number" min="1" max="60" name="battle_duration" value="30" class="duration-input">
        </div>

        <style>
        .duration-input {
            width: 60px; /* Adjust width as needed */
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            appearance: textfield; /* For consistent number input styling */
            -moz-appearance: textfield; /* Firefox */
        }

        /* Remove number input spinner arrows */
        .duration-input::-webkit-inner-spin-button,
        .duration-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        </style>

        <div class="form-actions">
            <button type="button" class="btn-secondary">Retreat</button>
            <button type="submit" class="btn-primary" onclick="startBattle(event)">Start Battle</button>
        </div>
    </form>
{% endcall %}